# ============================================================
# docker-compose.yml
# B2B AI Outreach System
# Start with: docker-compose up --build
# ============================================================

# version: "3.9"

services:

  # ----------------------------------------------------------
  # db: PostgreSQL 15 database
  # ----------------------------------------------------------
  db:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-b2b_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-b2b_password}
      POSTGRES_DB: ${POSTGRES_DB:-b2b_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432" # Expose for local debugging; remove in production
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-b2b_user} -d ${POSTGRES_DB:-b2b_db}" ]
      interval: 5s
      timeout: 5s
      retries: 10

  # ----------------------------------------------------------
  # web: FastAPI + LangGraph backend
  # ----------------------------------------------------------
  web:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8000:8000"
    env_file:
      - .env # Load all keys from .env (copy from .env.example)
    environment:
      # Override DATABASE_URL to point at the 'db' service (Docker service name)
      DATABASE_URL: postgresql://${POSTGRES_USER:-b2b_user}:${POSTGRES_PASSWORD:-b2b_password}@db:5432/${POSTGRES_DB:-b2b_db}
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./backend:/app/backend # Hot-reload for development

  # ----------------------------------------------------------
  # frontend: React (Vite) dashboard
  # ----------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - web

  # ----------------------------------------------------------
  # admin-ui: Vue Vben Admin dashboard
  # ----------------------------------------------------------
  admin-ui:
    build:
      context: ./vue-vben-admin
      dockerfile: scripts/deploy/Dockerfile
    image: vben-admin-local
    container_name: vben-admin
    ports:
      - "8010:8080"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G

volumes:
  postgres_data:
